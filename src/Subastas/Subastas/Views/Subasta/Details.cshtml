@using System.Security.Claims
@model Subastas.Domain.Subasta

@{
    bool isAdmin = User.IsInRole("Admin");
    bool isSubastaActiva = Model.EstaActivo;
}

<div class="container mt-2">
    <div class="row">
        <div class="col-md-6 mt-3">
            <h4>Detalles de la Subasta</h4>
            <hr />
            <div class="container mt-4">
                <div class="card">
                    <div class="row no-gutters">
                        <div class="col-md-12 text-center" style="padding: 5px 30px">
                            <img src="@(Model?.IdProductoNavigation?.ImagenProducto)" class="card-img" alt="Imagen de la Subasta" style="max-width: 275px;">
                        </div>
                        <div class="col-md-12">
                            <div class="card-body">
                                <h5 class="card-title">@Model.TituloSubasta</h5>
                                <dl class="row">
                                    @if (isAdmin)
                                    {
                                        <dt class="col-sm-3">#:</dt>
                                        <dd class="col-sm-9">@Model.IdSubasta</dd>
                                    }
                                    <dt class="col-sm-3">Monto actual:</dt>
                                    <dd class="col-sm-9" id="current-amount">$@Model.MontoInicial</dd>
                                    <dt class="col-sm-3">Estado:</dt>
                                    <dd class="col-sm-9">@(Model.EstaActivo ? "En Curso" : "Finalizada")</dd>
                                    @if(Model.IdUsuario > 0 && Model.IdUsuarioNavigation != null)
                                    {
                                        <dt class="col-sm-3">Ganador:</dt>
                                        <dd class="col-sm-9">@Model?.IdUsuarioNavigation?.NombreUsuario @Model?.IdUsuarioNavigation?.ApellidoUsuario</dd>
                                    }
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mt-3">
            <h4>Pujas de Usuarios</h4>
            <hr />
            <div style="max-height: 400px; overflow: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Monto</th>
                            <th>Fecha de Pujada</th>
                        </tr>
                    </thead>
                    <tbody id="bid-table-body">
                        @foreach (var item in Model.Pujas.OrderByDescending(x => x.MontoPuja))
                        {
                            <tr>
                                <td>@item.IdUsuarioNavigation.NombreUsuario</td>
                                <td>$@item.MontoPuja</td>
                                <td>@item.FechaPuja.ToString("dd/M/yyyy, H:mm:ss")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (isAdmin && isSubastaActiva)
    {
        <div class="row pt-3 mt-3">
            <div class="container d-flex justify-content-center">
                <button class="btn btn-danger text-white mx-2" id="btnTerminarSubasta">Terminar Subasta</button>
            </div>
        </div>
    }

    <div class="container d-flex justify-content-center mt-3">
        <button class="btn btn-primary text-white mx-2" id="btnPujar" @(isSubastaActiva ? "" : "disabled")>Pujar</button>
        <a asp-action="Index" class="btn btn-secondary text-white mx-2">Regresar</a>
    </div>

    <div class="container mt-2">
        <div class="row">
            <div class="col-lg-6 col-md-12 mt-3 d-flex flex-column" style="max-height: 400px;min-height: 400px;">
                <h4>Chat</h4>
                <hr />
                <div class="flex-grow-1 overflow-auto" style="border: 1px solid #ddd; padding: 10px;" id="chat-messages">
                    <!-- Aquí van los mensajes del chat -->
                </div>
                <div class="mt-1">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chat-input" placeholder="Escribe tu mensaje..." @(!isSubastaActiva ? "disabled" : "")>
                        <div class="input-group-append">
                            <button class="btn btn-primary btn-send-message" type="button" @(!isSubastaActiva ? "disabled" : "")>Enviar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-md-12 mt-3" style="max-height: 400px;min-height: 400px; overflow-y: auto;">
                <h4>Participantes de la Subasta</h4>
                <hr />
                <table class="table participants-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Fecha de Participación</th>
                        </tr>
                    </thead>
                    <tbody id="participants-table-body">
                        @foreach (var item in Model.ParticipantesSubasta)
                        {
                            <tr>
                                <td>@item.IdUsuarioNavigation.NombreUsuario</td>
                                <td>@item.IdSubastaNavigation.IdUsuarioNavigation.CorreoUsuario</td>
                                <td>@Model.FechaSubasta</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>

    <script>
        let currentUser = "@User.Identity.Name";
        let currentSubastaId = "@Model.IdSubasta";
        let isSubastaActiva = @(isSubastaActiva ? "true" : "false");

        document.getElementById("btnPujar").addEventListener("click", function () {
            if (isSubastaActiva) {
                Swal.fire({
                    title: 'Ingrese su puja',
                    input: 'number',
                    inputAttributes: {
                        min: parseFloat(document.getElementById("current-amount").innerText.replace('$', '')) + 1,
                        step: 1
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Pujar',
                    showLoaderOnConfirm: true,
                    preConfirm: (amount) => {
                        return fetch('/Pujas/Create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            },
                            body: JSON.stringify({
                                IdSubasta: @Model.IdSubasta,
                                MontoPuja: amount,
                                IdUsuario: @User.FindFirst(ClaimTypes.NameIdentifier)?.Value
                                    })
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(response.statusText);
                                }
                                return response.json();
                            })
                            .catch(error => {
                                Swal.showValidationMessage(
                                    `Request failed: ${error}`
                                );
                            });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (result.value != undefined && result.value.success) {
                            connection.invoke("SendBid", currentUser, result.value.montoPuja, currentSubastaId).catch(function (err) {
                                return console.error(err.toString());
                            });

                            Swal.fire({
                                title: 'Puja exitosa!',
                                text: `Su puja de $${result.value.montoPuja} fue aceptada.`,
                                icon: 'success'
                            }).then(() => {
                                event.preventDefault();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error en la puja',
                                text: `Ups... ${result.value.message}`,
                                icon: 'error'
                            });
                        }
                    }
                });
            }
        });

        let btnTerminar = document.getElementById("btnTerminarSubasta");

        if(btnTerminar != undefined){
            btnTerminar.addEventListener("click", function () {
                Swal.fire({
                    title: '¿Está seguro de que quiere terminar la subasta?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, terminar',
                    cancelButtonText: 'No, cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/Subasta/TerminarSubasta?idSubasta=' + currentSubastaId, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            }
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(response.statusText);
                                }
                                return response.json();
                            })
                            .then(data => {
                                Swal.fire({
                                    title: 'Subasta terminada',
                                    text: 'La subasta ha sido terminada por el administrador.',
                                    icon: 'success',
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    confirmButtonText: 'Aceptar'
                                }).then(() => {
                                    location.reload();
                                });
                            })
                            .catch(error => {
                                Swal.fire(
                                    'Error',
                                    `Hubo un problema al terminar la subasta: ${error}`,
                                    'error'
                                );
                            });
                    }
                });
            });
        }
    </script>

    <script src="~/js/SubastaHub.js" asp-append-version="true"></script>
}
